<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>User's Guide</title>

    <!-- Bootstrap: CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <!-- highlight.js -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/stackoverflow-light.min.css"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>

    <!-- favicon -->
    <link rel="icon" href="../../favicon.ico" />
  </head>

  <body class="d-flex flex-column h-100">
    <header class="bg-primary py-3 mb-3 position-relative">
      <div class="container col-lg-8">
        <a href="../../">
          <h1 class="text-white">Automated API Validation User's Guide</h1>
        </a>
      </div>
    </header>

    <main class="container col-lg-8">
      <section id="usage">
        <h2>Usage</h2>
        <p>
          This section will describe how to use our action in your Github
          Actions workflow.
        </p>
        <p>
          Using our action is similar to any other GitHub Action workflow. You
          simply reference the action and version in your workflow.
        </p>
        <pre><code class="language-yaml">name: API Validator Integration Tests
on:
  workflow_dispatch:

jobs:
  integration_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: engr-csc-sdc/2021FallTeam01-Bandwidth@master
        with:
          spec_file: /path/to/spec_file.json
          step_file: /path/to/step_file.yaml
          fail_fast: true
          verbose: false
        env:
          username: ${{ secrets.API_USERNAME }}
          password: ${{ secrets.API_PASSWORD }}</code></pre>

        <h3>Arguments</h3>
        <p>
          Below is a description of the arguments. Arguments are optional unless
          specified otherwise.
        </p>
        <ul>
          <li>
            <b>spec_file</b> (Required) &mdash; This is a path to an OpenAPI
            spec file within your repo. It should either be in JSON or YAML
            format.
          </li>
          <li>
            <b>step_file</b> (Required) &mdash; This is a path to the step file
            corresponding to your <code>spec_file</code>. See
            <a href="#step-files-how-to">How to Write a Step File</a> for
            information on the structure of a step file.
          </li>
          <li>
            <b>fail_fast</b> (Optional) &mdash; This flag will cancel all
            subsequent steps running if any step is not valid. Default:
            <code>false</code>.
          </li>
          <li>
            <b>verbose</b> (Optional) &mdash; The action will print the detailed
            stacktrace if any exception is raised.
          </li>
          <li>
            <b>Environment Variables</b> &mdash; All other arguments that you
            wish to use in your step files should be passed under
            <code>env</code>. You can reference GitHub secrets by using the
            <code>${{ secrets.my_secret }}</code> syntax.
          </li>
        </ul>

        <h3>Runner Requirements</h3>
        <p>
          If you plan of using self-hosted runners, your runner will need to
          have Docker installed. For information on how to install Docker on a
          self-hosted GitHub Actions runner, see
          <a href="../developers/index.html#github-actions-runner"
            >Developer's Guide &mdash; GitHub Actions Runner</a
          >
        </p>
      </section>

      <hr />

      <section id="step-files-how-to">
        <h2>How to Write a Step File</h2>
        <p>
          Step files describe what requests our action should make. In order to
          validate your API. They can be written in JSON or YAML. Although you
          can view our steps file JSON schema for yourself
          <a
            href="https://github.ncsu.edu/engr-csc-sdc/2021FallTeam01-Bandwidth/blob/master/api_validator/steps_schema.json"
            >here</a
          >, and examples of valid specs
          <a
            href="https://github.ncsu.edu/engr-csc-sdc/2021FallTeam01-Bandwidth/tree/master/test/fixtures/steps/valid"
            >here</a
          >, this section will go through the schema with examples and detail
          how certain features work.
        </p>

        <p>
          Below is a small example of a steps file for
          <code>example.com</code>
        </p>
        <pre><code class="language-yaml">coverage_threshold: 0.8
base_url: https://example.com
paths:
  /person:
    post:
      operationId: createPerson
      steps:
        - name: createPerson
          method: POST
          url: /person
          headers:
            Content-Type: application/json
          body:
            name: John Doe
            age: 42
        - name: getPerson
          method: GET
          url: /person
          params:
            id: ${{ steps.createPerson.response.body.id }}
          auth:
            username: ${{ env.username }}
            password: ${{ env.password }}</code></pre>
        <h3>Basic Structure</h3>
        <p>
          At the top level of a steps file, there are two required fields:
          <code>base_url</code> and <code>paths</code>. The
          <code>base_url</code> parameter is the base URL to which all requests
          will be sent. Paths is an object and is explained below.
        </p>
        <p>
          The <code>coverage_threshold</code> parameter is optional. If present,
          the action will compare the paths present in the spec to the paths
          present in the steps. If the proportion of paths present in the steps
          to paths present in the spec is less than the threshold, the action
          will fail and report which endpoints are uncovered. No matter if the
          <code>coverage_threshold</code> is present, the action will check for
          undocumented endpoints: those that are present in the steps but not
          the spec. If any of these are found, the action will fail.
        </p>

        <div class="alert alert-warning" role="alert">
          <b>Warning:</b> The <code>base_url</code> should be a URL without a
          trailing slash and without query parameters. However, our schema
          enforces only that it must be a valid URI according to
          <a href="https://datatracker.ietf.org/doc/html/rfc3986">RFC3986</a>.
        </div>

        <h4>The <code>paths</code> Object</h4>
        <p>
          The <code>paths</code> object contains a collection of path objects.
          The key for each path object must match the regular expression
          <a href="https://regexr.com/6a1nh"><code>^(\/(\w*|[\{\}]))+$</code></a
          >.
        </p>

        <p>
          Each path object is itself an object that contains a collection of
          keys. Each of these keys must be one of the following HTTP verbs:
          <code>GET</code>, <code>PUT</code>, <code>POST</code>,
          <code>DELETE</code>, or <code>PATCH</code>. These verbs are
          case-insensitive.
        </p>

        <p>
          The value from each HTTP verb key is called a <code>step-list</code>.
          Each step list must contain the following two keys:
          <code>operationId</code> and <code>steps</code>. The
          <code>operationId</code> value can be any string. The
          <code>steps</code> value is an array of <code>step</code> objects.
        </p>

        <h4>The <code>step</code> Object</h4>
        <p>The <code>step</code> object contains the following keys:</p>
        <ul>
          <li>
            <b><code>name</code></b> (Required) &mdash; This name identifies the
            step, which is used for referencing previous steps. The value can be
            any string that matches the regular expression <code>\w+</code>.
            Within each step list, the value of each name should be unique.
          </li>
          <li>
            <b><code>method</code></b> (Required) &mdash; This is the HTTP verb
            that defines the request type. It can any of <code>GET</code>,
            <code>PUT</code>, <code>POST</code>, <code>DELETE</code>, or
            <code>PATCH</code>. These verbs are case-insensitive.
          </li>
          <li>
            <b><code>url</code></b> (Required) &mdash; This is the unique part
            of the URL to which the request will be sent. You should not include
            the base URL in this value. You should not include any query
            parameters. Instead, those should be specified in the
            <code>params</code> object.
          </li>
          <li>
            <b><code>headers</code></b> &mdash; These are the HTTP headers that
            will be sent with the request.
          </li>
          <li>
            <b><code>body</code></b> &mdash; This is is any data that will be
            sent in the request body.
          </li>
          <li>
            <b><code>params</code></b> &mdash; This is any data that will be
            sent as part of the URL query (i.e. the stuff after <code>?</code>).
          </li>
          <li>
            <b><code>auth</code></b> &mdash; This is an object that contains two
            keys: <code>username</code> and <code>password</code>. These values
            are used in basic HTTP authorization.
          </li>
        </ul>

        <h3>Step References</h3>
        <h4>Referencing Previous Steps</h4>
        <p>
          You are able to reference the results of previous steps in the same
          <code>step-list</code>. This allows you to use the results of a
          previous step in a subsequent one. This can be useful if you don't
          know the exact value that the target API will return.
        </p>
        <p>
          To do this, you put the value inside of <code>${{ ... }}</code>,
          similar to how you would reference a secret or environment variable in
          a GitHub Actions workflow file. Inside these braces, you first say
          <code>steps</code> to signify that you're referencing steps. Next, you
          give the <code>name</code> of a previous step in the same step list,
          then either <code>request</code> to reference the request, or
          <code>response</code> to reference the response to the request. You
          can then reference various parts of the request or response, like
          <code>body</code> or <code>headers</code>. For example, if a previous
          step's name is <code>createPerson</code>, which has the following JSON
          response:
        </p>
        <pre><code class="language-json">{
  "id": "12345",
}</code></pre>
        <p>
          Then our current step could reference the value of this ID with the
          following syntax:
        </p>
        <pre><code class="language-yaml">- name: getPerson
  method: GET
  url: /person
  params:
    id: ${{ steps.createPerson.response.body.id }}</code></pre>
        <p>
          If the <code>base_url</code> for the steps is
          <code>https://example.com</code>, this would result in a GET request
          being sent to <code>https://example.com/person?id=%2212345%22</code>.
        </p>
        <p>
          Expressions can also be used in URLs, which will be interpolated one
          by one and resulted in an evaluated string.
        </p>
        <pre><code class="language-yaml">- name: getTransactionsOfUser
  method: PUT
  url: /users/${{ steps.createUser.response.body.id }}/transactions/${{ steps.getTransactions.response[0].body.id }}
</code></pre>
        <p>
          The URL will now become
          <code>https://example.com/users/12345/transactions/67890</code>.
        </p>
        <div class="alert alert-warning" role="alert">
          <b>Unsupported characters:</b> Make sure not to include forward
          slashes (<code>/</code>) and curly braces (<code>{}</code>) in the
          expression, because the expression parsing engine depends on the
          regular expression <code>\${{[^/{}]*}}</code> to match nested
          expression groups.
        </div>

        <h4>Referencing Environment Variables</h4>
        <p>
          Using the same <code>${{ ... }}</code> syntax as you use to reference
          previous steps, you can reference environment variables by having the
          first item within the brackets be <code>env</code>. You can then give
          the name of the environment variable. For example, you can reference
          the environment variables <code>username</code> and
          <code>password</code> with the following syntax:
        </p>
        <pre><code class="language-yaml">- name: getIndex
  method: GET
  url: /
  auth:
    username: ${{ env.username }}
    password: ${{ env.password }}</code></pre>

        <p>
          The names of environment variables are given in the
          <code>env</code> section of the workflow. You will also have access to
          the
          <a
            href="https://docs.github.com/en/actions/learn-github-actions/environment-variables"
            >default environment variables</a
          >
          given by GitHub Actions.
        </p>

        <div class="alert alert-warning" role="alert">
          <b>Warning:</b> Our action resolves these previous step and
          environment variable references using the <code>eval</code> function.
          This means that you may have the ability to do more complex things
          than simply get a reference. For example, you might reverse a string
          with <code>${{ steps.createPerson.response.body.id[::-1] }}</code>.
          However, any of these "features" are not officially supported, so we
          strongly recommend against using them.
        </div>
        <div class="alert alert-danger" role="alert">
          <b>Security Consideration: </b> Our action uses the
          <code>eval</code> function to resolve previous step and environment
          variable references. This means one might be able to execute arbitrary
          code inside these references. So, this action should not be run on
          code you do not trust (e.g. pull requests from outsiders).
        </div>
      </section>
    </main>

    <footer class="mt-auto py-4 bg-primary">
      <div class="container">
        <p class="m-0 text-center text-white">
          &copy; 2021 William Boyles, Savan Doshi, Manali Shirsekar, and Sheldon
          Yao
        </p>
      </div>
    </footer>
  </body>
</html>
